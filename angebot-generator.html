<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Kristallkraft Angebotsgenerator</title>

  <!-- Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=G-8MSBJB2KWM"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());
    gtag('config', 'G-8MSBJB2KWM', {
      page_title: 'Kristallkraft Angebotsgenerator',
      page_location: window.location.href,
      custom_map: {
        'custom_parameter_1': 'beraterin',
        'custom_parameter_2': 'kontaktkanal',
        'custom_parameter_3': 'session_id'
      }
    });
  </script>

  <style>
	body {
	  font-family: sans-serif;
	  padding: 40px;
	  background-color: #fafafa;
	  font-size: 15px;
	  line-height: 1.5;
	}

	h2, h3 {
	  margin-top: 25px;
	}

	.form-section {
	  max-width: 1200px;
	  margin-bottom: 40px;
	  background-color: #fff;
	  padding: 24px;
	  border-radius: 8px;
	  box-shadow: 0 2px 4px rgba(0,0,0,0.05);
	}

	.form-grid {
	  display: grid;
	  grid-template-columns: 180px 1fr;
	  gap: 16px 24px;
	  align-items: center;
	  margin-bottom: 16px;
	}

	@media (max-width: 600px) {
	  .form-grid {
		grid-template-columns: 1fr;
	  }
	}

	label {
	  font-weight: 600;
	}

	input, select, textarea {
	  padding: 12px;
	  font-size: 16px;
	  border: 1px solid #ccc;
	  border-radius: 6px;
	  width: 100%;
	  box-sizing: border-box;
	}

	textarea {
	  height: 240px;
	  resize: vertical;
	  margin-top: 24px;
	}

	button {
	  margin-top: 28px;
	  padding: 14px 24px;
	  font-size: 17px;
	  border: none;
	  background-color: #0077cc;
	  color: white;
	  border-radius: 6px;
	  cursor: pointer;
	  transition: background-color 0.2s ease;
	}

	button:hover {
	  background-color: #005fa3;
	}

	.add-product-button {
	  background-color: #28a745;
	  margin-top: 16px;
	  padding: 12px 20px;
	  font-size: 15px;
	}

	.add-product-button:hover {
	  background-color: #218838;
	}

	.remove-button {
	  background-color: #dc3545;
	  padding: 8px 12px;
	  font-size: 14px;
	  margin-left: 12px;
	}

	.remove-button:hover {
	  background-color: #c82333;
	}

	.product-selection {
	  background-color: #f8f9fa;
	  border: 1px solid #dee2e6;
	  border-radius: 8px;
	  padding: 0;
	  margin-bottom: 20px;
	  overflow: hidden;
	}

	.product-header {
	  background-color: #e9ecef;
	  border-bottom: 2px solid #dee2e6;
	  padding: 12px 20px;
	  margin-bottom: 0;
	  display: grid;
	  grid-template-columns: 180px 90px 130px 90px 130px 90px 110px;
	  gap: 10px;
	  align-items: center;
	}

	.product-header div {
	  font-weight: 600;
	  font-size: 12px;
	  text-align: center;
	  color: #495057;
	  text-transform: uppercase;
	  letter-spacing: 0.3px;
	  line-height: 1.2;
	  overflow: hidden;
	  text-overflow: ellipsis;
	  white-space: nowrap;
	}

	.product-header div:first-child {
	  text-align: center;
	}

	.product-input-row {
	  padding: 20px;
	}

	.product-row {
	  display: grid;
	  grid-template-columns: 180px 90px 130px 90px 130px 90px 110px;
	  gap: 10px;
	  align-items: center;
	  margin-bottom: 16px;
	}

	@media (max-width: 800px) {
	  .product-row {
		grid-template-columns: 1fr;
		gap: 8px;
	  }

	  .product-header {
		display: none;
	  }

	  .product-input-row {
		padding: 16px;
	  }
	}

	.added-product {
	  background-color: #e8f4fd;
	  border: 1px solid #0077cc;
	  border-radius: 8px;
	  padding: 16px;
	  margin-bottom: 12px;
	  display: flex;
	  align-items: center;
	  justify-content: space-between;
	  flex-wrap: wrap;
	  gap: 12px;
	}

	.product-info {
	  display: flex;
	  align-items: center;
	  gap: 12px;
	  flex: 1;
	}

	.product-icon {
	  height: 32px;
	  width: auto;
	}

	.product-details {
	  font-size: 14px;
	  color: #666;
	}

	#angebotHTML {
	  border: 1px solid #ccc;
	  padding: 24px;
	  margin-top: 32px;
	  background: #f9f9f9;
	  border-radius: 6px;
	}

	.success-notification {
	  background-color: #d4edda;
	  color: #155724;
	  padding: 12px;
	  border-radius: 6px;
	  margin-top: 16px;
	  display: none;
	}

	.copy-button {
	  background-color: #28a745;
	  margin-left: 10px;
	  padding: 8px 16px;
	  font-size: 14px;
	}

	.copy-button:hover {
	  background-color: #218838;
	}

	.no-products {
	  text-align: center;
	  color: #666;
	  font-style: italic;
	  padding: 20px;
	}

	.tracking-info {
	  background-color: #e7f3ff;
	  border: 1px solid #0077cc;
	  border-radius: 6px;
	  padding: 16px;
	  margin-top: 20px;
	  font-size: 14px;
	}

	.tracking-info h4 {
	  margin: 0 0 10px 0;
	  color: #0077cc;
	}
  </style>
</head>
<body>
  <h2>üõçÔ∏è Produkte & F√ºtterung konfigurieren</h2>

  <section class="form-section">
	<div class="form-grid">
	  <label for="kundenname">üë§ Kundenname:</label>
	  <input type="text" id="kundenname" placeholder="z. B. Max Mustermann" />
	</div>
	<div class="form-grid">
	  <label for="pferdename">üê¥ Name des Pferdes:</label>
	  <input type="text" id="pferdename" placeholder="z. B. Black Beauty" />
	</div>
	<div class="form-grid">
	  <label for="beraterin">üßë‚Äçüíº Beraterin:</label>
	  <select id="beraterin">
		<option value="">‚Äì Bitte w√§hlen ‚Äì</option>
		<option value="Sofie">Sofie</option>
		<option value="Merle">Merle</option>
		<option value="Steffi">Steffi</option>
		<option value="Katrin">Katrin</option>
		<option value="Nadin">Nadin</option>
		<option value="Bea">Bea</option>
		<option value="Tatjana">Tatjana</option>
	  </select>
	</div>

	<div class="form-grid">
	  <label for="kontaktkanal">‚òéÔ∏è Kontaktkanal:</label>
	  <select id="kontaktkanal">
		<option value="">‚Äì Bitte w√§hlen ‚Äì</option>
		<option value="telefon">Telefon</option>
		<option value="chat">Chat</option>
		<option value="e-mail">E-Mail</option>
	  </select>
	</div>

	<div class="form-grid">
	  <label for="outputMode">üìù Ausgabeformat:</label>
	  <select id="outputMode">
		<option value="text">Text (f√ºr Chat / WhatsApp)</option>
		<option value="html">HTML (f√ºr E-Mail)</option>
	  </select>
	</div>
	<div class="form-grid">
	  <label for="anrede">üôã‚Äç‚ôÇÔ∏è Anrede:</label>
	  <select id="anrede">
		<option value="du">Du</option>
		<option value="sie">Sie</option>
	  </select>
	</div>
  </section>

  <!-- Produkt-Auswahl Sektion -->
  <section class="form-section">
	<h3>üõí Produkte hinzuf√ºgen</h3>

	<div class="product-selection">
	  <div class="product-header">
		<div>Produkt</div>
		<div>Bestell-<br>menge</div>
		<div>Kurzzeitf√ºtterung</div>
		<div>F√ºtter-<br>menge</div>
		<div>Dauerf√ºtterung</div>
		<div>F√ºtter-<br>menge</div>
		<div></div>
	  </div>

	  <div class="product-input-row">
		<div class="product-row">
		  <select id="produktSelect">
			<option value="">‚Äì Produkt w√§hlen ‚Äì</option>
		  </select>
		  <input type="number" id="mengeInput" placeholder="Menge" min="0" value="1">
		  <select id="dauerSelect">
			<option value="">Wochen...</option>
			<option value="eine Woche">eine Woche</option>
			<option value="zwei Wochen">zwei Wochen</option>
			<option value="drei Wochen">drei Wochen</option>
			<option value="vier Wochen">vier Wochen</option>
			<option value="f√ºnf Wochen">f√ºnf Wochen</option>
			<option value="sechs Wochen">sechs Wochen</option>
		  </select>
		  <input type="text" id="startInput" placeholder="Messbecher">
		  <select id="abSelect">
			<option value="">Woche...</option>
			<option value="ab der zweiten Woche">ab der zweiten Woche</option>
			<option value="ab der dritten Woche">ab der dritten Woche</option>
			<option value="ab der vierten Woche">ab der vierten Woche</option>
			<option value="ab der f√ºnften Woche">ab der f√ºnften Woche</option>
			<option value="ab der sechsten Woche">ab der sechsten Woche</option>
			<option value="ab der siebten Woche">ab der siebten Woche</option>
		  </select>
		  <input type="text" id="nachInput" placeholder="Messbecher">
		  <button type="button" id="addProductButton" class="add-product-button">‚ûï Hinzuf√ºgen</button>
		</div>
	  </div>
	</div>

	<!-- Hinzugef√ºgte Produkte -->
	<div id="addedProductsList">
	  <div class="no-products">Noch keine Produkte hinzugef√ºgt</div>
	</div>
  </section>

  <button type="button" id="generateButton">üöÄ Angebotstext generieren</button>
  <button type="button" id="copyButton" class="copy-button" style="display:none;">üìã Text kopieren</button>

  <div class="success-notification" id="successNotification">
	‚úÖ Angebot erfolgreich erstellt!
  </div>

  <!-- Tracking Info Box -->
  <div class="tracking-info" id="trackingInfo" style="display:none;">
	<h4>üìä Tracking Information</h4>
	<p><strong>Session ID:</strong> <span id="sessionIdDisplay"></span></p>
	<p><strong>Link ID:</strong> <span id="linkIdDisplay"></span></p>
	<p><strong>Generiert am:</strong> <span id="timestampDisplay"></span></p>
	<p><strong>Anzahl Produkte:</strong> <span id="productCountDisplay"></span></p>
  </div>

  <h3>üìã Dein Angebotstext:</h3>
  <textarea id="angebotText" readonly>Noch kein Angebot erstellt.</textarea>
  <div id="angebotHTML" style="display:none;"></div>

  <script>
document.addEventListener("DOMContentLoaded", function () {
  const SHOP_DOMAIN = "kristallkraft-pferdefutter.de";
  const produkte = [
    { id: "42640144892146", name: "Kristallkraft No1" },
    { id: "42640145514738", name: "Kristallkraft No2" },
    { id: "43527031652617", name: "Kristallkraft Coolly" },
    { id: "42640147874034", name: "Kristallkraft Move" },
    { id: "42640136569074", name: "Kristallkraft Bronchiale" },
    { id: "42640142270706", name: "Kristallkraft Femmina" },
    { id: "42640136044786", name: "Kristallkraft Brave Horse" },
    { id: "42640139124978", name: "Kristallkraft Core" },
    { id: "44241608769801", name: "Kristallkraft Muscolo" },
    { id: "42640147185906", name: "Kristallkraft Mental Balance" },
    { id: "42712424906994", name: "Kristallkraft TheMineral" }
  ];

  const icons = {
    "Kristallkraft Coolly": "https://cdn.shopify.com/s/files/1/0632/5449/5474/files/cl_gratissack.svg",
    "Kristallkraft No1": "https://cdn.shopify.com/s/files/1/0632/5449/5474/files/no1_gratissack.svg",
    "Kristallkraft No2": "https://cdn.shopify.com/s/files/1/0632/5449/5474/files/no2_gratissack.svg",
    "Kristallkraft Move": "https://cdn.shopify.com/s/files/1/0632/5449/5474/files/move_gratissack.svg",
    "Kristallkraft Bronchiale": "https://cdn.shopify.com/s/files/1/0632/5449/5474/files/bro_gratissack.svg",
    "Kristallkraft TheMineral": "https://cdn.shopify.com/s/files/1/0632/5449/5474/files/tm_gratissack.svg",
    "Kristallkraft Mental Balance": "https://cdn.shopify.com/s/files/1/0632/5449/5474/files/mb_gratissack.svg",
    "Kristallkraft Muscolo": "https://cdn.shopify.com/s/files/1/0632/5449/5474/files/muscolo_gratissack.svg",
    "Kristallkraft Femmina": "https://cdn.shopify.com/s/files/1/0632/5449/5474/files/femmina_gratissack.svg",
    "Kristallkraft Brave Horse": "https://cdn.shopify.com/s/files/1/0632/5449/5474/files/brave_horse_gratissack.svg",
    "Kristallkraft Core": "https://cdn.shopify.com/s/files/1/0632/5449/5474/files/core_gratissack.svg"
  };

  let addedProducts = [];
  let sessionId = getOrCreateSessionId();

  // Session ID Management
  function getOrCreateSessionId() {
    let sessionId = sessionStorage.getItem('kristallkraft_session_id');
    if (!sessionId) {
      sessionId = generateUniqueId();
      sessionStorage.setItem('kristallkraft_session_id', sessionId);
    }
    return sessionId;
  }

  // Dropdown mit Produkten f√ºllen
  const produktSelect = document.getElementById("produktSelect");
  produkte.forEach(prod => {
    const option = document.createElement("option");
    option.value = prod.id;
    option.textContent = prod.name;
    produktSelect.appendChild(option);
  });

  // Erweiterte Tracking-Funktionen
  function generateUniqueId() {
    return Date.now().toString(36) + Math.random().toString(36).substr(2);
  }

  function saveTrackingData(data) {
    const trackingData = JSON.parse(sessionStorage.getItem('kristallkraft_tracking') || '[]');
    trackingData.push({
      ...data,
      timestamp: new Date().toISOString(),
      linkId: generateUniqueId(),
      sessionId: sessionId
    });
    sessionStorage.setItem('kristallkraft_tracking', JSON.stringify(trackingData));
  }

  // Umfassendes Event-Tracking
  function trackEvent(eventName, eventData = {}) {
    const trackingEvent = {
      event: eventName,
      timestamp: new Date().toISOString(),
      sessionId: sessionId,
      url: window.location.href,
      userAgent: navigator.userAgent,
      ...eventData
    };

    // Console Log f√ºr Debugging
    console.log('üìä Tracking Event:', trackingEvent);

    // SessionStorage f√ºr lokale Speicherung
    const events = JSON.parse(sessionStorage.getItem('kristallkraft_events') || '[]');
    events.push(trackingEvent);
    sessionStorage.setItem('kristallkraft_events', JSON.stringify(events));

    // Google Analytics (GA4) - Enhanced Events
    if (typeof gtag !== 'undefined') {
      // Basis-Event f√ºr GA4
      gtag('event', eventName, {
        event_category: 'Angebotsgenerator',
        event_label: eventData.label || eventName,
        beraterin: eventData.beraterin || '',
        kontaktkanal: eventData.kontaktkanal || '',
        session_id: sessionId,
        value: eventData.value || 0,
        currency: 'EUR',
        ...eventData
      });

      // Spezielle GA4 E-Commerce Events
      if (eventName === 'angebot_generated') {
        gtag('event', 'generate_lead', {
          currency: 'EUR',
          value: eventData.produktWert || 0,
          beraterin: eventData.beraterin,
          kontaktkanal: eventData.kontaktkanal,
          items: eventData.produkte?.map((prod, index) => ({
            item_id: prod.id || `item_${index}`,
            item_name: prod.name,
            category: 'Kristallkraft',
            quantity: prod.menge || 1,
            price: 50 // Durchschnittspreis - kann angepasst werden
          })) || []
        });
      }

      if (eventName === 'product_added') {
        gtag('event', 'add_to_cart', {
          currency: 'EUR',
          value: 50, // Durchschnittspreis
          items: [{
            item_id: eventData.produktId,
            item_name: eventData.produktName,
            category: 'Kristallkraft',
            quantity: eventData.menge || 1,
            price: 50
          }]
        });
      }
    }

    // Facebook Pixel - falls vorhanden
    if (typeof fbq !== 'undefined') {
      fbq('track', 'CustomEvent', {
        event_name: eventName,
        session_id: sessionId,
        ...eventData
      });
    }

    // Matomo/Piwik - falls vorhanden
    if (typeof _paq !== 'undefined') {
      _paq.push(['trackEvent', 'Angebotsgenerator', eventName, eventData.label || '', eventData.value || 0]);
    }

    // Server-seitiges Tracking (optional)
    // sendToServer(trackingEvent);
  }

  // Optional: Server-seitiges Tracking
  function sendToServer(trackingEvent) {
    // Nur aktivieren wenn Server-Endpoint vorhanden
    // fetch('/api/tracking', {
    //   method: 'POST',
    //   headers: {
    //     'Content-Type': 'application/json',
    //   },
    //   body: JSON.stringify(trackingEvent)
    // }).catch(error => {
    //   console.error('Tracking error:', error);
    // });
  }

  // Berater speichern
  const savedBeraterin = sessionStorage.getItem("beraterin");
  if (savedBeraterin) {
    document.getElementById("beraterin").value = savedBeraterin;
  }

  document.getElementById("beraterin").addEventListener("change", (e) => {
    sessionStorage.setItem("beraterin", e.target.value);
    trackEvent('berater_selected', { beraterin: e.target.value });
  });

  // Kontaktkanal Tracking
  document.getElementById("kontaktkanal").addEventListener("change", (e) => {
    trackEvent('kontaktkanal_selected', { kontaktkanal: e.target.value });
  });

  // Output Mode Tracking + Copy Button Visibility
  document.getElementById("outputMode").addEventListener("change", (e) => {
    trackEvent('output_mode_selected', { outputMode: e.target.value });

    // Copy Button Sichtbarkeit basierend auf Output Mode
    const copyButton = document.getElementById("copyButton");
    if (e.target.value === "text") {
      // Bei Text-Modus: Button anzeigen falls bereits ein Angebot generiert wurde
      if (document.getElementById("angebotText").value !== "Noch kein Angebot erstellt.") {
        copyButton.style.display = "inline-block";
      }
    } else {
      // Bei HTML-Modus: Button verstecken
      copyButton.style.display = "none";
    }
  });

  // Copy Button Funktionalit√§t
  document.getElementById("copyButton").addEventListener("click", () => {
    const mode = document.getElementById("outputMode").value;
    const textArea = document.getElementById("angebotText");

    if (mode === "text") {
      textArea.select();
      document.execCommand('copy');
    }

    // Tracking f√ºr Copy-Aktion
    trackEvent('angebot_copied', {
      outputMode: mode,
      produktAnzahl: addedProducts.length
    });

    const button = document.getElementById("copyButton");
    const originalText = button.textContent;
    button.textContent = "‚úÖ Kopiert!";
    button.style.backgroundColor = "#28a745";
    setTimeout(() => {
      button.textContent = originalText;
      button.style.backgroundColor = "#28a745";
    }, 2000);
  });

  // Produkt hinzuf√ºgen mit Tracking
  document.getElementById("addProductButton").addEventListener("click", () => {
    const produktId = document.getElementById("produktSelect").value;
    const menge = parseInt(document.getElementById("mengeInput").value);
    const dauer = document.getElementById("dauerSelect").value;
    const start = document.getElementById("startInput").value.trim();
    const ab = document.getElementById("abSelect").value;
    const nach = document.getElementById("nachInput").value.trim();

    if (!produktId) {
      alert("Bitte w√§hle ein Produkt aus.");
      return;
    }

    if (isNaN(menge) || menge <= 0) {
      alert("Bitte gib eine g√ºltige Menge ein.");
      return;
    }

    const produkt = produkte.find(p => p.id === produktId);
    if (!produkt) return;

    // Tracking f√ºr Produkt hinzuf√ºgen
    trackEvent('product_added', {
      produktName: produkt.name,
      produktId: produktId,
      menge: menge,
      dauer: dauer,
      totalProdukte: addedProducts.length + 1
    });

    // Pr√ºfen ob Produkt bereits hinzugef√ºgt wurde
    const existingIndex = addedProducts.findIndex(p => p.id === produktId);
    if (existingIndex !== -1) {
      // Produkt aktualisieren
      addedProducts[existingIndex] = {
        id: produktId,
        name: produkt.name,
        menge,
        dauer,
        start,
        ab,
        nach
      };
    } else {
      // Neues Produkt hinzuf√ºgen
      addedProducts.push({
        id: produktId,
        name: produkt.name,
        menge,
        dauer,
        start,
        ab,
        nach
      });
    }

    updateAddedProductsList();
    clearProductForm();
  });

  function clearProductForm() {
    document.getElementById("produktSelect").value = "";
    document.getElementById("mengeInput").value = "1";
    document.getElementById("dauerSelect").value = "";
    document.getElementById("startInput").value = "";
    document.getElementById("abSelect").value = "";
    document.getElementById("nachInput").value = "";
  }

  function updateAddedProductsList() {
    const container = document.getElementById("addedProductsList");

    if (addedProducts.length === 0) {
      container.innerHTML = '<div class="no-products">Noch keine Produkte hinzugef√ºgt</div>';
      return;
    }

    container.innerHTML = addedProducts.map((prod, index) => {
      let details = [];
      if (prod.start && prod.dauer) details.push(`${prod.start} Messbecher t√§glich f√ºr ${prod.dauer}`);
      else if (prod.start) details.push(`${prod.start} Messbecher t√§glich`);
      if (prod.ab && prod.nach) details.push(`${prod.ab} ${prod.nach} Messbecher t√§glich`);

      const detailsText = details.length > 0 ? `<div class="product-details">${details.join(", ")}</div>` : "";

      return `
        <div class="added-product">
          <div class="product-info">
            <img src="${icons[prod.name] || ''}" alt="${prod.name}" class="product-icon">
            <div>
              <strong>${prod.name}</strong> (${prod.menge}x)
              ${detailsText}
            </div>
          </div>
          <button type="button" class="remove-button" onclick="removeProduct(${index})">üóëÔ∏è Entfernen</button>
        </div>
      `;
    }).join("");
  }

  // Globale Funktion zum Entfernen von Produkten mit Tracking
  window.removeProduct = function(index) {
    const removedProduct = addedProducts[index];

    // Tracking f√ºr Produkt entfernen
    trackEvent('product_removed', {
      produktName: removedProduct.name,
      produktId: removedProduct.id,
      totalProdukte: addedProducts.length - 1
    });

    addedProducts.splice(index, 1);
    updateAddedProductsList();
  };

  // Hauptfunktion zum Generieren des Angebots mit erweitertem Tracking
  document.getElementById("generateButton").addEventListener("click", () => {
    const kunde = document.getElementById("kundenname").value.trim();
    const pferd = document.getElementById("pferdename")?.value.trim() || "";
    const kanal = document.getElementById("kontaktkanal").value.trim();
    const berater = document.getElementById("beraterin").value.trim();
    const mode = document.getElementById("outputMode").value;
    const anrede = document.getElementById("anrede")?.value || "du";
    const outputText = document.getElementById("angebotText");
    const outputHTML = document.getElementById("angebotHTML");

    if (addedProducts.length === 0) {
      outputText.value = "‚ùó Bitte f√ºge mindestens ein Produkt hinzu.";
      outputHTML.style.display = "none";
      outputText.style.display = "block";

      // Tracking f√ºr Fehler
      trackEvent('generation_error', {
        error: 'no_products',
        kunde: kunde,
        berater: berater,
        kontaktkanal: kanal
      });

      return;
    }

    // Tracking-Parameter erstellen
    const trackingParams = new URLSearchParams();
    trackingParams.set('utm_source', 'servicelink');
    if (kanal) trackingParams.set('utm_medium', kanal);
    if (berater) trackingParams.set('utm_content', berater);

    const linkId = generateUniqueId();
    trackingParams.set('link_id', linkId);
    trackingParams.set('session_id', sessionId);
    trackingParams.set('created', Date.now());

    let items = [];
    let textProdukte = [];
    let produktWert = 0;

    addedProducts.forEach(prod => {
      let details = [];
      if (prod.start && prod.dauer) details.push(`${prod.start} Messbecher t√§glich f√ºr ${prod.dauer}`);
      else if (prod.start) details.push(`${prod.start} Messbecher t√§glich`);
      if (prod.ab && prod.nach) details.push(`${prod.ab} ${prod.nach} Messbecher t√§glich`);

      const zusatz = details.length > 0 ? ` (${details.join(", ")})` : "";
      items.push(`${prod.id}:${prod.menge}`);
      textProdukte.push(`${prod.name}${zusatz}`);
      produktWert += prod.menge; // Vereinfachte Wertberechnung
    });

    const cartUrl = `https://${SHOP_DOMAIN}/cart/${items.join(',')}?${trackingParams.toString()}`;

    // Haupttracking-Event f√ºr Angebotsgenerierung
    trackEvent('angebot_generated', {
      kunde: kunde,
      pferd: pferd,
      beraterin: berater,
      kontaktkanal: kanal,
      outputMode: mode,
      anrede: anrede,
      linkId: linkId,
      produktAnzahl: addedProducts.length,
      produktWert: produktWert,
      produkte: addedProducts.map(p => ({ name: p.name, menge: p.menge })),
      cartUrl: cartUrl
    });

    // Speichern der Tracking-Daten
    saveTrackingData({
      kunde,
      pferd,
      beraterin: berater,
      kontaktkanal: kanal,
      linkId,
      sessionId,
      produkte: textProdukte,
      cartUrl,
      outputMode: mode,
      anrede: anrede
    });

    // Anzeige der Tracking-Informationen
    document.getElementById("sessionIdDisplay").textContent = sessionId;
    document.getElementById("linkIdDisplay").textContent = linkId;
    document.getElementById("timestampDisplay").textContent = new Date().toLocaleString('de-DE');
    document.getElementById("productCountDisplay").textContent = addedProducts.length;
    document.getElementById("trackingInfo").style.display = "block";

    let begruessung = `Hallo ${kunde},\n\n`;
    let einleitung = "";
    let hinweis = "";
    let abschluss = "";

    if (anrede === "du") {
      einleitung = `danke f√ºr die ganzen Infos!\nAuf dieser Basis empfehlen wir dir folgende Produkte f√ºr dein Pferd${pferd ? ` ${pferd}` : ""}:\n\n`;
      hinweis = `Du musst einfach nur auf den Link klicken und schon werden die entsprechenden Produkte automatisch deinem Warenkorb hinzugef√ºgt:\n`;
      abschluss = `\nWenn du weitere Fragen hast, melde dich gerne jederzeit wieder bei uns!`;
    } else {
      einleitung = `danke f√ºr die ganzen Informationen!\nAuf dieser Basis empfehlen wir Ihnen folgende Produkte f√ºr Ihr Pferd${pferd ? ` ${pferd}` : ""}:\n\n`;
      hinweis = `Sie m√ºssen einfach nur auf den Link klicken und schon werden die entsprechenden Produkte automatisch Ihrem Warenkorb hinzugef√ºgt:\n`;
      abschluss = `\nSollten Sie weitere Fragen haben, melden Sie sich gerne jederzeit wieder bei uns!`;
    }

    const bodyText = `${begruessung}${einleitung}${textProdukte.join("\n")}\n\n${hinweis}üëâ Jetzt bestellen: ${cartUrl}${abschluss}`;

    if (mode === "text") {
      outputText.style.display = "block";
      outputHTML.style.display = "none";
      outputText.value = bodyText;
      // Copy Button nur bei Text-Modus anzeigen
      document.getElementById("copyButton").style.display = "inline-block";
    } else {
      outputText.style.display = "none";
      outputHTML.style.display = "block";
      outputHTML.innerHTML = `
        <p>${kunde ? `Hallo ${kunde},` : ""}</p>
        <p>${anrede === "du"
          ? `danke f√ºr die ganzen Infos!<br>Auf dieser Basis empfehlen wir dir folgende Produkte f√ºr dein Pferd${pferd ? ` ‚Äû${pferd}"` : ""}:`
          : `danke f√ºr die ganzen Informationen!<br>Auf dieser Basis empfehlen wir Ihnen folgende Produkte f√ºr Ihr Pferd${pferd ? ` ‚Äû${pferd}"` : ""}:`
        }</p>
        <ul>${textProdukte.map(p => `<li>${p}</li>`).join("")}</ul>
        <p>${anrede === "du"
          ? `Du musst einfach nur auf den Link klicken und schon werden die entsprechenden Produkte automatisch deinem Warenkorb hinzugef√ºgt:`
          : `Sie m√ºssen einfach nur auf den Link klicken und schon werden die entsprechenden Produkte automatisch Ihrem Warenkorb hinzugef√ºgt:`
        }</p>
        <p>
          üëâ <a href="${cartUrl}" target="_blank" style="display:inline-block;padding:10px 20px;background:#4CAF50;color:white;text-decoration:none;border-radius:5px;" onclick="trackEvent('cart_link_clicked', {linkId: '${linkId}', produktAnzahl: ${addedProducts.length}, beraterin: '${berater}', kontaktkanal: '${kanal}'});">üõí Jetzt bestellen</a>
        </p>
        <p>${anrede === "du"
          ? `Wenn du weitere Fragen hast, melde dich gerne jederzeit wieder bei uns!`
          : `Sollten Sie weitere Fragen haben, melden Sie sich gerne jederzeit wieder bei uns!`
        }</p>
      `;
      // Copy Button bei HTML-Modus verstecken
      document.getElementById("copyButton").style.display = "none";
    }
    document.getElementById("successNotification").style.display = "block";
    setTimeout(() => {
      document.getElementById("successNotification").style.display = "none";
    }, 5000);
  });

  // Seiten-Load Tracking
  trackEvent('page_loaded', {
    userAgent: navigator.userAgent,
    referrer: document.referrer,
    timestamp: new Date().toISOString()
  });

  // Seiten-Verlassen Tracking
  window.addEventListener('beforeunload', () => {
    trackEvent('page_unload', {
      timeOnPage: Date.now() - performance.timing.navigationStart,
      produkteHinzugefuegt: addedProducts.length
    });
  });
});
</script>
  <canvas id="confettiCanvas" style="position:fixed;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:9999;"></canvas>
  <script>
	const canvas = document.getElementById("confettiCanvas");
	const ctx = canvas.getContext("2d");
  
	function resizeCanvas() {
	  canvas.width = window.innerWidth;
	  canvas.height = window.innerHeight;
	}
	resizeCanvas();
	window.addEventListener('resize', resizeCanvas);
  
	function launchConfettiFromButton(button) {
	  const rect = button.getBoundingClientRect();
	  const originX = rect.left + rect.width / 2;
	  const originY = rect.top + rect.height / 2;
  
	  const particles = [];
	  const colors = ['#f00', '#0f0', '#00f', '#ff0', '#0ff', '#f0f'];
  
	  for (let i = 0; i < 80; i++) {
		const angle = Math.random() * 2 * Math.PI;
		const speed = Math.random() * 5 + 2;
		particles.push({
		  x: originX,
		  y: originY,
		  dx: Math.cos(angle) * speed,
		  dy: Math.sin(angle) * speed,
		  radius: Math.random() * 4 + 2,
		  color: colors[Math.floor(Math.random() * colors.length)],
		  life: 60 // frames
		});
	  }
  
	  function animate() {
		ctx.clearRect(0, 0, canvas.width, canvas.height);
		particles.forEach(p => {
		  ctx.beginPath();
		  ctx.arc(p.x, p.y, p.radius, 0, 2 * Math.PI);
		  ctx.fillStyle = p.color;
		  ctx.fill();
		  p.x += p.dx;
		  p.y += p.dy;
		  p.dy += 0.2; // gravity
		  p.life--;
		});
  
		// Remove dead particles
		for (let i = particles.length - 1; i >= 0; i--) {
		  if (particles[i].life <= 0) {
			particles.splice(i, 1);
		  }
		}
  
		if (particles.length > 0) {
		  requestAnimationFrame(animate);
		} else {
		  ctx.clearRect(0, 0, canvas.width, canvas.height);
		}
	  }
  
	  animate();
	}
  
	document.getElementById("generateButton").addEventListener("click", (e) => {
	  const button = e.currentTarget;
	  launchConfettiFromButton(button);
	});
  </script>
</body>
</html>
